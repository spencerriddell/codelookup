[{"name": "app.py", "content": "from shiny import App, ui, render, reactive\nfrom typing import List, Dict, Any\n\n# === Constants and data (ported from codelookup.py) ===\n\nSAS_TEMPLATE = \"\"\"\n/* {var_value} */\ndata new_varxx;\nYearNum = 2023;\nVarValID = {varvalid};\nTopic_ID = {topic_id};\nSubTopic_ID = {subtopic_id};\nExcludeInclude = 1;\nSortOrder = 1;\nTopic_SortOrder = 1;\nSubTopic_SortOrder = 1;\nTopic_DefaultID = 1;\nDefaultID = 1;\nIndicator_SortOrder = ;\nYearDate = \"2023-01-01\";\nDataset = \"{dataset}\";\nDataset_Name = \"{dataset_name}\";\nDataset_Type = \"Health Surveys\";\nVarCode = \"{var_code}\";\nVarValue = \"{var_value}\";\nVarType = \"{var_type}\";\nVarName = \"{var_name}\";\nDescription = \"{description}\";\nTopic = \"{topic}\";\nSub_Topic = \"{sub_topic}\";\nPopulationDatasource = \"{population}\";\nNote1 = \"\";\nNote2 = \"\";\nNote3 = \"\";\nCrossNotes = \"\";\nMapTitlePrefix = \"\";\nMapTitleSuffix = \"\";\nMapInsert = \"\";\nVarComments = \"\";\nTag = \"{var_name}_{tag_suffix}\";\nDefaultPopulationSource = \"{population}\";\noutput;\nrun;\n\"\"\"\n\nTOPICS = {\n    \"Children and Youth\": {\n        \"id\": 5,\n        \"subtopics\": {\n            \"Child Development and Disabilities\": 26,\n            \"Day Care and School\": 34,\n            \"Drug and Alcohol Use\": 10,\n            \"Health Care Use\": 17,\n            \"Health Insurance\": 15,\n            \"Household and Neighborhood\": 16,\n            \"Health Status\": 18,\n            \"Mental Health\": 3,\n            \"Nutrition\": 23,\n            \"Physical Activity\": 35,\n            \"Physical Health Conditions\": 12,\n            \"Population Characteristics\": 11,\n            \"Safety\": 4,\n            \"Sleep\": 33,\n            \"Sexual Behavior\": 30,\n            \"Smoking\": 7,\n            \"Violence\": 1,\n        },\n    },\n    \"Healthy Living\": {\n        \"id\": 4,\n        \"subtopics\": {\n            \"Vaccinations\": 29,\n            \"Drug and Alcohol Use\": 10,\n            \"Health Status\": 18,\n            \"Nutrition\": 23,\n            \"Physical Activity\": 35,\n            \"Safety\": 4,\n            \"Screening\": 19,\n            \"Sexual Behavior\": 30,\n        },\n    },\n    \"Sleep\": {\"id\": 33, \"subtopics\": {}},\n    \"Smoking\": {\"id\": 7, \"subtopics\": {}},\n    \"Vaccinations\": {\"id\": 29, \"subtopics\": {}},\n    \"Violence\": {\"id\": 1, \"subtopics\": {}},\n    \"Community Characteristics\": {\n        \"id\": 6,\n        \"subtopics\": {\n            \"Day Care and School\": 34,\n            \"Economic Factors\": 31,\n            \"Population Characteristics\": 11,\n            \"Social Factors\": 13,\n        },\n    },\n    \"Living and Environmental Conditions\": {\n        \"id\": 7,\n        \"subtopics\": {\n            \"Built Environment\": 28,\n            \"Housing\": 14,\n        },\n    },\n    \"Safety\": {\"id\": 4, \"subtopics\": {}},\n    \"Social Factors\": {\"id\": 13, \"subtopics\": {}},\n    \"Mental Health\": {\n        \"id\": 3,\n        \"subtopics\": {\n            \"Drug and Alcohol Use\": 10,\n            \"Mental Health Conditions\": 20,\n            \"Mental Health Counseling and Treatment\": 27,\n        },\n    },\n    \"Diseases and Conditions\": {\n        \"id\": 1,\n        \"subtopics\": {\n            \"Child Development and Disabilities\": 26,\n            \"Chronic Diseases\": 24,\n            \"Dental Health\": 21,\n            \"Foodborne or Waterborne Infections\": 43,\n            \"HIV-AIDS\": 8,\n            \"Hearing and Vision Health\": 36,\n            \"Hepatitis Infections\": 48,\n            \"Invasive Bacterial Infections\": 45,\n            \"Mosquitoborne Infections\": 37,\n            \"Other and Rare Diseases\": 46,\n            \"Person-to-Person Infections\": 44,\n            \"Respiratory Infections\": 41,\n            \"Sexually Transmitted Infections\": 5,\n            \"Syndromic Surveillance\": 39,\n            \"Tickborne Infections\": 42,\n            \"Tuberculosis\": 53,\n            \"Vaccine-Preventable Diseases\": 47,\n            \"Zoonotic Infections\": 40,\n        },\n    },\n    \"Health Care Access and Use\": {\n        \"id\": 2,\n        \"subtopics\": {\n            \"Health Care Use\": 17,\n            \"Health Insurance\": 15,\n            \"Mental Health Counseling and Treatment\": 27,\n            \"Screening\": 19,\n            \"Vaccinations\": 29,\n        },\n    },\n    \"Birth and Death\": {\n        \"id\": 8,\n        \"subtopics\": {\n            \"Birth\": 38,\n            \"Infant Mortality\": 51,\n            \"Leading Cause of Death\": 52,\n            \"Mortality and Premature Mortality\": 49,\n        },\n    },\n}\n\nSURVEYS = {\n    \"YRBS\": {\"full_name\": \"NYC Youth Risk Behavior Survey\", \"population\": \"Youth\", \"tag_suffix\": \"YRBS\"},\n    \"CHS\": {\"full_name\": \"Community Health Survey\", \"population\": \"Adult\", \"tag_suffix\": \"CHS\"},\n    \"HANES\": {\"full_name\": \"NYC Health and Nutrition Examination Survey\", \"population\": \"Adult\", \"tag_suffix\": \"HANES\"},\n    \"CCHS\": {\"full_name\": \"NYC Child Health Data\", \"population\": \"Youth\", \"tag_suffix\": \"CCHS\"},\n}\n\ndef compute_ids(var_type: str, topic: str, sub_topic: str) -> Dict[str, int]:\n    topic_id = TOPICS.get(topic, {}).get(\"id\", 0) if topic else 0\n    subtopic_id = 0\n    if var_type == \"Indicator\" and topic in TOPICS:\n        subtopic_id = TOPICS.get(topic, {}).get(\"subtopics\", {}).get(sub_topic, 0)\n    return {\"topic_id\": topic_id, \"subtopic_id\": subtopic_id}\n\ndef generate_sas_for_variable(var_data: Dict[str, Any]) -> List[str]:\n    parts: List[str] = []\n    ids = compute_ids(var_data[\"var_type\"], var_data.get(\"topic\", \"\"), var_data.get(\"sub_topic\", \"\"))\n    for idx, val in enumerate(var_data[\"levels\"], start=1):\n        parts.append(\n            SAS_TEMPLATE.format(\n                varvalid=idx,\n                topic_id=ids[\"topic_id\"],\n                subtopic_id=ids[\"subtopic_id\"],\n                dataset=var_data[\"dataset\"],\n                dataset_name=var_data[\"dataset_name\"],\n                var_code=var_data[\"var_code\"],\n                var_value=val,\n                var_type=var_data[\"var_type\"],\n                var_name=var_data[\"var_name\"],\n                description=var_data[\"description\"],\n                topic=var_data.get(\"topic\", \"\"),\n                sub_topic=var_data.get(\"sub_topic\", \"\"),\n                population=var_data[\"population\"],\n                tag_suffix=var_data[\"tag_suffix\"],\n            )\n        )\n        parts.append(\"\")  # blank line between entries\n    return parts\n\n# === UI: two-column layout for queue and generated code ===\n\ntopic_options = sorted(TOPICS.keys())\n\napp_ui = ui.page_fluid(\n    ui.h2(\"SAS Code Generator (Client-side, Shinylive)\"),\n    ui.layout_sidebar(\n        ui.sidebar(\n            ui.input_select(\"dataset\", \"Survey Dataset\", choices=list(SURVEYS.keys()), selected=\"YRBS\"),\n            ui.input_text(\"var_code\", \"Variable Code\"),\n            ui.input_text(\"var_name\", \"Variable Name\"),\n            ui.input_text(\"description\", \"Description\"),\n            ui.input_select(\"var_type\", \"Variable Type\", choices=[\"Indicator\", \"Demographic\"], selected=\"Indicator\"),\n            ui.input_select(\"topic\", \"Topic\", choices=topic_options, selected=topic_options[0]),\n            ui.input_select(\"sub_topic\", \"Sub-Topic\", choices=[], selected=None),\n            ui.input_numeric(\"levels\", \"Number of Levels\", 2, min=2, max=6),\n            ui.output_ui(\"level_inputs\"),\n            ui.input_action_button(\"add_var\", \"Add Variable to Queue\", class_=\"btn-primary\"),\n            ui.input_action_button(\"clear_queue\", \"Clear Queue\", class_=\"btn-secondary\"),\n            ui.hr(),\n            ui.input_action_button(\"generate\", \"Generate SAS Code\", class_=\"btn-success\"),\n            ui.hr(),\n            ui.output_text_verbatim(\"validation_errors\"),\n        ),\n        ui.row(\n            ui.column(\n                6,\n                ui.card(\n                    ui.card_header(\"Queued Variables\"),\n                    ui.output_text_verbatim(\"queue_summary\"),\n                ),\n            ),\n            ui.column(\n                6,\n                ui.card(\n                    ui.card_header(\"Generated SAS Code\"),\n                    ui.output_text_verbatim(\"sas_code\"),\n                ),\n            ),\n        ),\n    ),\n)\n\ndef server(input, output, session):\n    queued: reactive.Value[List[Dict[str, Any]]] = reactive.Value([])\n    last_error: reactive.Value[str] = reactive.Value(\"\")\n\n    # Dynamic subtopic handling and enable/disable logic\n    @reactive.calc\n    def current_subtopics():\n        vt = input.var_type()\n        topic = input.topic()\n        if vt == \"Demographic\" or not topic:\n            return []\n        return sorted(TOPICS.get(topic, {}).get(\"subtopics\", {}).keys())\n\n    @reactive.effect\n    def _sync_subtopics():\n        subs = current_subtopics()\n        # Update choices and selection\n        session.send_input_message(\n            \"sub_topic\",\n            {\n                \"options\": [{\"label\": s, \"value\": s} for s in subs],\n                \"selected\": (subs[0] if subs else None),\n            },\n        )\n        # Disable topic/sub_topic when Demographic\n        vt = input.var_type()\n        session.send_input_message(\"topic\", {\"disabled\": vt == \"Demographic\"})\n        session.send_input_message(\"sub_topic\", {\"disabled\": vt == \"Demographic\"})\n\n    @output\n    @render.ui\n    def level_inputs():\n        n = int(input.levels() or 2)\n        return ui.div(*[ui.input_text(f\"level_{i}\", f\"Level {i} Name\") for i in range(1, n + 1)])\n\n    def validate_current() -> str:\n        if not input.dataset():\n            return \"Please select a Survey Dataset.\"\n        if not (input.var_code() or \"\").strip():\n            return \"Please enter Variable Code.\"\n        if not (input.var_name() or \"\").strip():\n            return \"Please enter Variable Name.\"\n        if not (input.description() or \"\").strip():\n            return \"Please enter Description.\"\n        vt = input.var_type()\n        if vt not in [\"Indicator\", \"Demographic\"]:\n            return \"Please select Variable Type.\"\n        if vt == \"Indicator\":\n            if not input.topic() or not input.sub_topic():\n                return \"Please select Topic and Sub-Topic for Indicators.\"\n        try:\n            n = int(input.levels())\n        except Exception:\n            return \"Please select a valid Number of Levels.\"\n        if not (2 <= n <= 6):\n            return \"Number of Levels must be between 2 and 6.\"\n        for i in range(1, n + 1):\n            name = (session.get_input(f\"level_{i}\") or \"\").strip()\n            if not name:\n                return f\"Please enter a name for Level {i}.\"\n        return \"\"\n\n    def build_var_data() -> Dict[str, Any]:\n        dataset = input.dataset()\n        survey = SURVEYS[dataset]\n        n = int(input.levels())\n        levels = [(session.get_input(f\"level_{i}\") or \"\").strip() for i in range(1, n + 1)]\n        var_type = input.var_type()\n        topic = input.topic() if var_type == \"Indicator\" else \"\"\n        sub_topic = input.sub_topic() if var_type == \"Indicator\" else \"\"\n        ids = compute_ids(var_type, topic, sub_topic)\n        return {\n            \"dataset\": dataset,\n            \"dataset_name\": survey[\"full_name\"],\n            \"population\": survey[\"population\"],\n            \"tag_suffix\": survey[\"tag_suffix\"],\n            \"var_code\": (input.var_code() or \"\").strip(),\n            \"var_name\": (input.var_name() or \"\").strip(),\n            \"description\": (input.description() or \"\").strip(),\n            \"var_type\": var_type,\n            \"topic\": topic,\n            \"sub_topic\": sub_topic,\n            \"topic_id\": ids[\"topic_id\"],\n            \"subtopic_id\": ids[\"subtopic_id\"],\n            \"levels\": levels,\n        }\n\n    @reactive.event(input.add_var)\n    def add_var():\n        err = validate_current()\n        last_error.set(err)\n        if err:\n            session.send_notification(err, type=\"error\")\n            # Force redraw of validation_errors\n            queued.set(queued.get())\n            return\n        q = queued.get().copy()\n        q.append(build_var_data())\n        queued.set(q)\n        last_error.set(\"\")\n        session.send_notification(\"Variable added to queue.\", type=\"message\")\n\n    @reactive.event(input.clear_queue)\n    def _clear():\n        queued.set([])\n        session.send_notification(\"Queue cleared.\", type=\"message\")\n\n    @output\n    @render.text\n    def validation_errors():\n        return last_error.get() or \"\"\n\n    @output\n    @render.text\n    def queue_summary():\n        q = queued.get()\n        if not q:\n            return \"No variables queued.\"\n        lines = []\n        for i, v in enumerate(q, start=1):\n            lines.append(\n                f\"{i}. [{v['dataset']}] {v['var_code']} - {v['var_name']} \"\n                f\"({v['var_type']}) Levels: {len(v['levels'])}\"\n            )\n        return \"\\n\".join(lines)\n\n    @reactive.event(input.generate)\n    def _generate():\n        # Trigger re-render of sas_code; show error if queue empty\n        if not queued.get():\n            msg = \"No variables to generate SAS code.\"\n            last_error.set(msg)\n            session.send_notification(msg, type=\"error\")\n\n    @output\n    @render.text\n    def sas_code():\n        q = queued.get()\n        if not q:\n            return \"No variables to generate SAS code.\"\n        parts: List[str] = []\n        for v in q:\n            parts.extend(generate_sas_for_variable(v))\n        return \"\\n\".join(parts)\n\napp = App(app_ui, server)\n", "type": "text"}]